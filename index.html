<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>N-4</title>
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --color-blue-bg: rgba(0, 122, 255, 0.15);
            --color-blue-text: #007AFF;
            --color-yellow-bg: rgba(255, 159, 10, 0.15);
            --color-yellow-text: #FF9500;
            --color-gray-bg: rgba(142, 142, 147, 0.2);
            --color-gray-text: #8E8E93;
            --color-green: #34C759;
            --color-red: #FF3B30;
            --font-stack: "SF Pro Text", -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; background: var(--bg-color); color: var(--text-primary); font-family: var(--font-stack); display: flex; justify-content: center; min-height: 100vh; padding-bottom: 40px; }
        .container { width: 100%; max-width: 390px; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 22px; box-shadow: 0 4px 16px rgba(0,0,0,0.03); }
        .day-counter { text-align: center; font-size: 13px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; opacity: 0.8; }
        .clock-row { display: flex; justify-content: space-between; align-items: center; }
        .clock-item { text-align: center; flex: 1; }
        .clock-label { font-size: 10px; color: var(--text-secondary); font-weight: 700; letter-spacing: 0.5px; margin-bottom: 6px; }
        .clock-time { font-size: 24px; font-weight: 300; font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }
        .clock-date { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
        .divider { width: 1px; height: 36px; background: rgba(0,0,0,0.08); }
        .est-display { text-align: center; margin-bottom: 20px; padding: 14px; background: rgba(52,199,89,0.06); border-radius: 16px; }
        .est-label { font-size: 10px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; margin-bottom: 4px;}
        .est-value { font-size: 28px; font-weight: 700; color: var(--color-green); font-variant-numeric: tabular-nums; }
        .btn-group { display: flex; gap: 12px; }
        .btn { flex: 1; padding: 16px; border: none; border-radius: 16px; font-weight: 600; font-size: 16px; color: #fff; cursor: pointer; transition: all 0.2s; }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn:disabled { background: #E5E5EA !important; color: #C7C7CC; cursor: default; transform: none; }
        .btn-in { background: #007AFF; box-shadow: 0 4px 10px rgba(0,122,255,0.2); }
        .btn-out { background: var(--color-red); box-shadow: 0 4px 10px rgba(255,59,48,0.2); }
        
        /* Calendar Header */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .section-title { font-size: 17px; font-weight: 700; }
        .nav-btn { background: none; border: none; font-size: 18px; color: #007AFF; cursor: pointer; padding: 5px 10px; }
        .nav-btn:active { opacity: 0.5; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); row-gap: 12px; margin-bottom: 24px; justify-items: center; }
        .cal-day-header { font-size: 10px; font-weight: 700; color: #C7C7CC; }
        .cal-day { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border-radius: 50%; transition: all 0.2s; }
        .status-blue { background: var(--color-blue-bg); color: var(--color-blue-text); }
        .status-yellow { background: var(--color-yellow-bg); color: var(--color-yellow-text); }
        .status-gray { background: var(--color-gray-bg); color: var(--color-gray-text); }
        .today-active { border: 1.5px solid #007AFF; color: #007AFF; }
        
        /* Multi-Stats Row */
        .stats-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; border-top: 0.5px solid rgba(0,0,0,0.08); padding-top: 18px; }
        .stats-detail { display: flex; grid-column: span 2; justify-content: space-between; margin-bottom: 10px; }
        .detail-item { text-align: center; flex: 1; }
        .detail-val { font-size: 16px; font-weight: 700; }
        .detail-lbl { font-size: 8px; font-weight: 600; text-transform: uppercase; margin-top: 2px; }
        
        .stat-item { text-align: center; }
        .stat-val { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
        .stat-lbl { font-size: 9px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px; }
        
        .footer { text-align: center; font-size: 9px; color: #C7C7CC; margin-top: 16px; letter-spacing: 1px; }
    </style>
</head>
<body>
<div class="container">
    <div class="card"><div class="day-counter" id="dayDisplay">DAY -- AT TDS</div></div>
    <div class="card">
        <div class="clock-row">
            <div class="clock-item">
                <div class="clock-label">CST (BJ)</div>
                <div class="clock-time" id="shTime">00:00:00</div>
                <div class="clock-date" id="shDate">--/--</div>
            </div>
            <div class="divider"></div>
            <div class="clock-item">
                <div class="clock-label">EST (NY)</div>
                <div class="clock-time" id="nyTime">00:00:00</div>
                <div class="clock-date" id="nyDate">--/--</div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="est-display">
            <div class="est-label">Est. Off-Duty (8.5H Fixed)</div>
            <div id="estOut" class="est-value">--:--</div>
        </div>
        <div class="btn-group">
            <button id="inBtn" class="btn btn-in" onclick="doPunch('IN')">Clock IN</button>
            <button id="outBtn" class="btn btn-out" onclick="doPunch('OUT')">Clock OUT</button>
        </div>
    </div>
    <div class="card">
        <div class="section-header">
            <button class="nav-btn" onclick="changeMonth(-1)">❮</button>
            <div id="calMonthStr" class="section-title">--</div>
            <button class="nav-btn" onclick="changeMonth(1)">❯</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        
        <div class="stats-row">
            <div class="stats-detail">
                <div class="detail-item" style="color:var(--color-blue-text)">
                    <div class="detail-val" id="cntBlue">0</div><div class="detail-lbl">Complete</div>
                </div>
                <div class="detail-item" style="color:var(--color-yellow-text)">
                    <div class="detail-val" id="cntYellow">0</div><div class="detail-lbl">Incomplete</div>
                </div>
                <div class="detail-item" style="color:var(--color-gray-text)">
                    <div class="detail-val" id="cntGray">0</div><div class="detail-lbl">Missed</div>
                </div>
            </div>
            <div class="stat-item"><div class="stat-val" id="totalHours">0.0</div><div class="stat-lbl">Total Hours</div></div>
            <div class="stat-item"><div class="stat-val" id="totalDays">0</div><div class="stat-lbl">Days Worked</div></div>
        </div>
    </div>
    <div class="footer">N-4 VERSION 27.4 • ADVANCED STATS</div>
</div>

<script>
const CFG = { token: "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", repo: "lishengze-collab/simplify-v18-app", path: "workplace-sync.json", start: "2022/05/04" };
let db = { punches: {} };
let cloudSha = "";
const LOCAL_KEY = "TDS_V27_4_STORE";
let currentViewDate = new Date(); // 用于日历切换

window.onload = async () => { loadLocal(); initClock(); renderUI(); await pull(); };

function initClock() { tick(); setInterval(tick, 1000); }

function loadLocal() { 
    const data = localStorage.getItem(LOCAL_KEY); 
    if(data) db.punches = JSON.parse(data).punches || {}; 
}

function save() { 
    localStorage.setItem(LOCAL_KEY, JSON.stringify(db)); 
    renderUI(); setTimeout(push, 500); 
}

async function pull() { 
    try { 
        const r = await fetch(`https://api.github.com/repos/${CFG.repo}/contents/${CFG.path}`, { headers: { "Authorization": `token ${CFG.token}`, "Cache-Control": "no-cache" } }); 
        if(r.ok) { 
            const j = await r.json(); cloudSha = j.sha; 
            const remote = JSON.parse(decodeURIComponent(escape(atob(j.content)))); 
            db.punches = remote.punches || {}; renderUI();
        } 
    } catch(e) {} 
}

async function push() { 
    try { 
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(db)))); 
        await fetch(`https://api.github.com/repos/${CFG.repo}/contents/${CFG.path}`, { method: "PUT", headers: { "Authorization": `token ${CFG.token}`, "Content-Type": "application/json" }, body: JSON.stringify({ message: "N-4 V27.4 Sync", content, sha: cloudSha }) }); 
    } catch(e) {} 
}

function changeMonth(dir) {
    currentViewDate.setMonth(currentViewDate.getMonth() + dir);
    renderUI();
}

function tick() {
    const now = new Date();
    const fmt = (z) => ({ timeZone: z, hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
    const fmtD = (z) => ({ timeZone: z, year:'numeric', month:'2-digit', day:'2-digit' });
    
    document.getElementById('shTime').innerText = now.toLocaleTimeString('en-GB', fmt('Asia/Shanghai'));
    document.getElementById('shDate').innerText = now.toLocaleDateString('en-GB', fmtD('Asia/Shanghai')).split('/').reverse().join('-');
    document.getElementById('nyTime').innerText = now.toLocaleTimeString('en-GB', fmt('America/New_York'));
    document.getElementById('nyDate').innerText = now.toLocaleDateString('en-GB', fmtD('America/New_York')).split('/').reverse().join('-');

    const diffDays = Math.floor((now - new Date(CFG.start)) / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById('dayDisplay').innerText = `DAY ${diffDays} AT TDS`;
    
    const k = getK(now);
    const todayData = db.punches[k] || [];
    document.getElementById('inBtn').disabled = todayData.some(p => p.type === 'IN');
    document.getElementById('outBtn').disabled = !todayData.some(p => p.type === 'IN') || todayData.some(p => p.type === 'OUT');
    
    const firstIn = todayData.find(p => p.type === 'IN');
    if(firstIn) {
        const target = new Date(new Date(firstIn.time).getTime() + 8.5 * 60 * 60 * 1000);
        document.getElementById('estOut').innerText = `${String(target.getHours()).padStart(2,'0')}:${String(target.getMinutes()).padStart(2,'0')}`;
        document.getElementById('estOut').style.color = 'var(--color-green)';
    } else {
        document.getElementById('estOut').innerText = "--:--";
        document.getElementById('estOut').style.color = 'var(--text-secondary)';
    }
}

function doPunch(type) { 
    const k = getK(new Date()); 
    if(!db.punches[k]) db.punches[k] = []; 
    db.punches[k].push({ type, time: Date.now() }); 
    save(); 
}

function renderUI() {
    const grid = document.getElementById('calendarGrid');
    const now = new Date();
    const year = currentViewDate.getFullYear();
    const month = currentViewDate.getMonth();
    
    document.getElementById('calMonthStr').innerText = currentViewDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    grid.innerHTML = ['S','M','T','W','T','F','S'].map(d => `<div class="cal-day-header">${d}</div>`).join('');
    
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayIndex = new Date(year, month, 1).getDay();
    for(let i=0; i<firstDayIndex; i++) grid.innerHTML += `<div></div>`;
    
    let totalH = 0, daysW = 0, cBlue = 0, cYellow = 0, cGray = 0;

    for(let d=1; d<=daysInMonth; d++) {
        const cellDate = new Date(year, month, d);
        const k = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = (d === now.getDate() && month === now.getMonth() && year === now.getFullYear());
        const isPast = (cellDate < new Date().setHours(0,0,0,0));
        const isWeekend = (cellDate.getDay() === 0 || cellDate.getDay() === 6);

        const data = db.punches[k] || [];
        const hasIn = data.some(p => p.type === 'IN');
        const hasOut = data.some(p => p.type === 'OUT');
        
        let cls = "", hrs = 0;
        if (hasIn && hasOut) {
            cls = "status-blue"; cBlue++;
            hrs = (data.find(p=>p.type==='OUT').time - data.find(p=>p.type==='IN').time) / 3600000;
            daysW++;
        } else if (hasIn && !hasOut) {
            if (isToday) { cls = "today-active"; daysW++; } 
            else { cls = "status-yellow"; cYellow++; hrs = 8.5; daysW++; }
        } else if (!hasIn && isPast && !isWeekend) {
            cls = "status-gray"; cGray++;
        }
        
        totalH += hrs;
        const el = document.createElement('div');
        el.className = `cal-day ${cls}`;
        el.innerText = d;
        if(hasIn) el.onclick = () => { if(confirm(`Edit ${k}?`)) adjustTime(k); };
        grid.appendChild(el);
    }
    
    document.getElementById('totalHours').innerText = totalH.toFixed(1);
    document.getElementById('totalDays').innerText = daysW;
    document.getElementById('cntBlue').innerText = cBlue;
    document.getElementById('cntYellow').innerText = cYellow;
    document.getElementById('cntGray').innerText = cGray;
}

function getK(d) { return d.toLocaleDateString('en-CA', { timeZone: 'America/New_York' }); }

function adjustTime(k) {
    const p = db.punches[k]; const idx = p.findIndex(x => x.type === 'IN');
    const val = prompt("New IN time (HH:mm):", "09:30");
    if(val && val.includes(":")) {
        const [h,m] = val.split(":").map(Number);
        const t = new Date(p[idx].time); t.setHours(h,m,0,0);
        p[idx].time = t.getTime(); save();
    }
}
</script>
</body>
</html>
