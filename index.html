<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simplify Workspace V20</title>
    
    <style>
        :root {
            --bg-color: #F2F2F7;
            --card-bg: rgba(255, 255, 255, 0.92);
            --primary-blue: #007AFF;
            --primary-light-blue: #5AC8FA;
            --success-green: #34C759;
            --warning-orange: #FF9500;
            --danger-red: #FF3B30;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: rgba(60, 60, 67, 0.18);
            --card-radius: 20px;
            --btn-radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; outline: none; user-select: none; }
        input, textarea { user-select: auto; }
        
        body { font-size: 15px; background-color: var(--bg-color); color: var(--text-primary); margin: 0; padding: 20px 12px; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 400px; display: none; flex-direction: column; gap: 16px; padding-bottom: 40px; }

        /* 登录页样式 */
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); display:flex; align-items:center; justify-content:center; z-index:9999; }
        .login-card { width:90%; max-width:320px; padding:30px; background:var(--card-bg); border-radius:var(--card-radius); box-shadow:0 10px 30px rgba(0,0,0,0.1); text-align:center; }
        .login-input { width:100%; padding:12px; margin:8px 0; border:1px solid var(--border-color); border-radius:12px; font-size:16px; text-align:center; }
        .login-btn { width:100%; padding:14px; background:var(--primary-blue); color:white; border-radius:12px; margin-top:15px; font-weight:700; }

        /* 通用样式 */
        .card { background: var(--card-bg); backdrop-filter: blur(25px); border-radius: var(--card-radius); padding: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.4); overflow: hidden; }
        .card h2 { font-size: 1.1rem; font-weight: 700; margin: 0 0 12px 0; }
        .app-header { text-align: center; margin-bottom: 5px; }
        .tenure-badge { color: var(--text-secondary); padding: 4px 0; font-size: 1.1rem; font-weight: 700; margin-top: 10px; }

        button { border: none; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.1s; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        
        .time-display { display: flex; justify-content: space-between; padding-bottom: 15px; margin-bottom: 15px; border-bottom: 0.5px solid var(--border-color); }
        .time-zone { text-align: center; flex: 1; }
        .time-zone:first-child { border-right: 0.5px solid var(--border-color); }
        .time-label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 700; margin-bottom: 4px;}
        .time-value { font-size: 1.4rem; font-weight: 700; margin: 0; font-variant-numeric: tabular-nums; }
        
        .punch-controls { display: flex; gap: 12px; margin-top: 10px; }
        .punch-btn { flex: 1; padding: 14px 0; border-radius: var(--btn-radius); color: white; }
        .btn-in { background: var(--primary-blue); }
        .btn-out { background: var(--danger-red); }
        
        .stats-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; }
        .progress-track { height: 10px; background: #E5E5EA; border-radius: 10px; margin: 14px 0; overflow: hidden; display: flex; }
        .bar-work { background: var(--primary-blue); height: 100%; }
        .bar-break { background: var(--primary-light-blue); height: 100%; }

        /* 滑动删除项通用样式 */
        .swipe-item { display: flex; align-items: center; position: relative; transition: transform 0.2s; background: white; width: 100%; }
        .delete-action { position: absolute; right: -80px; width: 80px; height: 100%; background: var(--danger-red); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; }

        /* 历史记录样式 */
        .history-date-header { font-size: 0.75rem; font-weight: 800; color: var(--text-secondary); margin-top: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 2px; }
        .history-row { padding: 10px 0; border-bottom: 0.5px solid var(--border-color); font-size: 0.85rem; width:100%; }

        /* 日历与备忘录 */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); row-gap: 6px; text-align: center; }
        .day-cell { width: 26px; height: 26px; line-height: 26px; margin: 0 auto; font-size: 0.75rem; position: relative; }
        .day-cell.has-punch::after { content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--text-primary); border-radius: 50%; }
        .memo-area { width: 100%; min-height: 100px; border: none; background: transparent; font-size: 0.9rem; line-height: 1.5; resize: none; }

        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 3000; backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background: white; width: 280px; border-radius: 14px; text-align: center; padding: 20px 0 0; }
        .modal-input { width: 80%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; text-align: center; }
        .modal-actions { display: flex; border-top: 0.5px solid rgba(60,60,67,0.2); }
        .modal-btn { flex: 1; padding: 12px; color: var(--primary-blue); background: none; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="margin-top:0">Workspace Login</h2>
        <input type="text" id="username" class="login-input" placeholder="Username">
        <input type="password" id="password" class="login-input" placeholder="Password">
        <button class="login-btn" onclick="checkLogin()">Login</button>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px; display:none;">Incorrect credentials</p>
    </div>
</div>

<div class="container" id="mainApp">
    <div class="app-header">
        <h1 style="font-size:1.6rem; font-weight:800; margin:0">Simplify, simplify</h1>
        <div class="tenure-badge" id="tenureCounter">Day --</div>
    </div>

    <div class="card">
        <div class="time-display">
            <div class="time-zone">
                <div class="time-label">CST</div>
                <div class="time-value" id="cstTime">00:00:00</div>
            </div>
            <div class="time-zone">
                <div class="time-label">EST</div>
                <div class="time-value" id="estTime">00:00:00</div>
            </div>
        </div>
        <div class="punch-controls">
            <button class="punch-btn btn-in" onclick="handlePunch('in')">Clock In</button>
            <button class="punch-btn btn-out" onclick="handlePunch('out')">Clock Out</button>
        </div>
        <div class="status-text" style="text-align:center; font-size:0.85rem; margin-top:12px; color:var(--text-secondary);">
            <span id="statusText" style="color:var(--text-primary); font-weight:600">--</span> <span id="etaText"></span>
        </div>
    </div>

    <div class="card">
        <h2>Daily Summary</h2>
        <div class="stats-row"><span>Work Time</span><span id="valWork">0h 0m (0%)</span></div>
        <div class="stats-row"><span>Break Time</span><span id="valBreak">0h 0m (0%)</span></div>
        <div class="progress-track" id="progressTrack"></div>
        <button class="punch-btn btn-in" style="width:100%; background:var(--success-green)" id="btnBreak" onclick="handleBreak()">Start Break</button>
    </div>

    <div class="card">
        <div style="display:flex; gap:12px;">
            <div style="flex:1.2;"><div id="calGrid" class="cal-grid"></div></div>
            <div style="flex:1.5;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span style="font-weight:700">To-do</span>
                    <button style="background:none; color:var(--primary-blue); font-size:1.4rem;" onclick="openTodoModal()">+</button>
                </div>
                <ul id="todoList" style="list-style:none; padding:0; margin:0; height:150px; overflow-y:auto; overflow-x:hidden;"></ul>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Memo</h2>
        <textarea class="memo-area" id="memoInput" placeholder="Write something..." oninput="saveMemo()"></textarea>
    </div>

    <div class="card">
        <h2>Cumulative Stats</h2>
        <div class="stats-row"><span>Total Work Days</span><span id="totalDays">0</span></div>
        <div class="stats-row"><span>Total Hours</span><span id="totalHours">0h 0m</span></div>
    </div>

    <div class="card">
        <h2>Punch History</h2>
        <div id="historyList" style="max-height:250px; overflow-y:auto; overflow-x:hidden;"></div>
    </div>

    <button class="punch-btn" style="background:#E5E5EA; color:var(--danger-red); width:100%;" ondblclick="fullReset()">Double Tap to Reset</button>
</div>

<div id="todoModal" class="modal-backdrop">
    <div class="modal-content">
        <div style="padding-bottom:15px; font-weight:600">New Task</div>
        <input type="text" id="modalInput" class="modal-input">
        <div class="modal-actions">
            <button class="modal-btn" onclick="closeTodoModal()">Cancel</button>
            <button class="modal-btn" style="font-weight:700" onclick="saveTodo()">Save</button>
        </div>
    </div>
</div>

<script>
const DATA_KEY = 'timeTracker_V20.0_Data'; // 升级到新 Key
const OLD_KEY = 'timeTracker_V18.2_Data'; // 指定旧版 Key
const START_DATE = '2022-05-04';
let appData = { punches: {}, breaks: {}, todos: [], memo: "" };

// 登录验证
function checkLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    if(u === 'lishengze' && p === '09876123') {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        initApp();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function initApp() {
    migrateData(); // 自动执行数据迁移
    loadData();
    setInterval(updateClock, 1000);
    setInterval(calculateStats, 1000);
    renderCalendar();
    renderTodos();
    initTenure();
}

// 核心：自动数据迁移逻辑
function migrateData() {
    const newData = localStorage.getItem(DATA_KEY);
    const oldData = localStorage.getItem(OLD_KEY);
    if (!newData && oldData) {
        localStorage.setItem(DATA_KEY, oldData);
        console.log("V18.2 数据已自动迁移至 V20.0");
    }
}

function loadData() {
    const raw = localStorage.getItem(DATA_KEY);
    if (raw) appData = JSON.parse(raw);
    document.getElementById('memoInput').value = appData.memo || "";
}

function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(appData)); }

function updateClock() {
    const now = new Date();
    document.getElementById('cstTime').innerText = now.toLocaleTimeString('en-GB', {timeZone:'Asia/Shanghai', hour12:false});
    document.getElementById('estTime').innerText = now.toLocaleTimeString('en-GB', {timeZone:'America/New_York', hour12:false});
}

function isDST(date) {
    const year = date.getFullYear();
    const start = new Date(year, 2, 14); start.setDate(14 - start.getDay());
    const end = new Date(year, 10, 7); end.setDate(7 - end.getDay());
    return date >= start && date < end;
}

function calculateStats() {
    const key = new Date().toLocaleDateString('en-CA', {timeZone:'America/New_York'});
    const now = new Date();
    const dayPunches = appData.punches[key] || [];
    const dayBreaks = appData.breaks[key] || [];

    let workMs = 0, breakMs = 0, isClockedIn = false, isOnBreak = false;

    dayBreaks.forEach(b => {
        if (b.end) breakMs += (new Date(b.end) - new Date(b.start));
        else { breakMs += (now - new Date(b.start)); isOnBreak = true; }
    });

    let lastIn = null;
    dayPunches.forEach(p => {
        if (p.type === 'in') { lastIn = new Date(p.time); isClockedIn = true; }
        else if (lastIn) { workMs += (new Date(p.time) - lastIn); lastIn = null; isClockedIn = false; }
    });
    if (isClockedIn && lastIn) workMs += (now - lastIn);

    const netWorkMs = Math.max(0, workMs - breakMs);
    const totalSessionMs = workMs; 
    const workPct = totalSessionMs > 0 ? Math.round((netWorkMs / totalSessionMs) * 100) : 0;
    const breakPct = totalSessionMs > 0 ? Math.round((breakMs / totalSessionMs) * 100) : 0;

    document.getElementById('valWork').innerText = `${formatDur(netWorkMs)} (${workPct}%)`;
    document.getElementById('valBreak').innerText = `${formatDur(breakMs)} (${breakPct}%)`;
    
    const wp = totalSessionMs > 0 ? (netWorkMs / totalSessionMs) * 100 : 0;
    document.getElementById('progressTrack').innerHTML = `<div class="bar-work" style="width:${wp}%"></div><div class="bar-break" style="width:${100-wp}%"></div>`;

    const etaEl = document.getElementById('etaText');
    const statusEl = document.getElementById('statusText');
    if (isClockedIn && dayPunches.length > 0) {
        statusEl.innerText = isOnBreak ? "On Break" : "Working";
        const firstIn = new Date(dayPunches[0].time);
        const standardDayMs = 8.5 * 60 * 60 * 1000;
        const finishTime = new Date(firstIn.getTime() + standardDayMs + breakMs);
        etaEl.innerText = `| ${finishTime.toLocaleTimeString('en-GB', {timeZone:'America/New_York', hour:'2-digit', minute:'2-digit'})}(${finishTime.toLocaleTimeString('en-GB', {timeZone:'Asia/Shanghai', hour:'2-digit', minute:'2-digit'})})`;
    } else {
        statusEl.innerText = dayPunches.length > 0 ? "Clocked Out" : "Ready";
        etaEl.innerText = "";
    }
    updateCumulative();
    renderHistory();
}

// 通用滑动逻辑
let touchStartX = 0;
function handleSwipeStart(e) { touchStartX = e.touches[0].clientX; }
function handleSwipeMove(e) {
    let diff = touchStartX - e.touches[0].clientX;
    let target = e.currentTarget;
    if (diff > 20) target.style.transform = `translateX(-${Math.min(diff, 80)}px)`;
    else target.style.transform = `translateX(0)`;
}
function handleSwipeEnd(e) {
    let diff = touchStartX - e.changedTouches[0].clientX;
    let target = e.currentTarget;
    if (diff > 50) target.style.transform = `translateX(-80px)`;
    else target.style.transform = `translateX(0)`;
}

function renderTodos() {
    const list = document.getElementById('todoList');
    list.innerHTML = '';
    appData.todos.forEach((t, i) => {
        const li = document.createElement('li');
        li.className = 'swipe-item';
        li.style.borderBottom = '0.5px solid var(--border-color)';
        li.style.padding = '10px 0';
        li.setAttribute('ontouchstart', 'handleSwipeStart(event)');
        li.setAttribute('ontouchmove', 'handleSwipeMove(event)');
        li.setAttribute('ontouchend', 'handleSwipeEnd(event)');
        li.innerHTML = `
            <input type="checkbox" style="margin-right:10px" ${t.done?'checked':''} onchange="toggleTodo(${i})">
            <span style="flex:1; font-size:0.9rem; ${t.done?'text-decoration:line-through;color:#8E':''}">${t.text}</span>
            <div class="delete-action" onclick="deleteTodo(${i})">Delete</div>
        `;
        list.appendChild(li);
    });
}

function renderHistory() {
    const container = document.getElementById('historyList');
    const oldHtml = container.innerHTML;
    const keys = Object.keys(appData.punches).sort().reverse();
    let newHtml = '';
    keys.forEach(k => {
        const d = new Date(k);
        newHtml += `<div class="history-date-header">${d.toLocaleDateString('en-GB').replace(/\//g,'')}</div>`;
        appData.punches[k].forEach((p, idx) => {
            const time = new Date(p.time).toLocaleTimeString('en-GB', {timeZone:'Asia/Shanghai', hour12:false});
            newHtml += `
                <div class="swipe-item" ontouchstart="handleSwipeStart(event)" ontouchmove="handleSwipeMove(event)" ontouchend="handleSwipeEnd(event)">
                    <div class="history-row">
                        <span style="color:${p.type==='in'?'var(--primary-blue)':'var(--danger-red)'}">${p.type.toUpperCase()}</span> at ${time}
                    </div>
                    <div class="delete-action" onclick="deletePunch('${k}', ${idx})">Delete</div>
                </div>`;
        });
    });
    if(newHtml !== oldHtml) container.innerHTML = newHtml;
}

function handlePunch(type) {
    const key = new Date().toLocaleDateString('en-CA', {timeZone:'America/New_York'});
    if (!appData.punches[key]) appData.punches[key] = [];
    appData.punches[key].push({ type, time: new Date().toISOString() });
    saveData();
}

function deletePunch(key, idx) { appData.punches[key].splice(idx, 1); if(appData.punches[key].length===0) delete appData.punches[key]; saveData(); renderHistory(); }
function handleBreak() {
    const key = new Date().toLocaleDateString('en-CA', {timeZone:'America/New_York'});
    if (!appData.breaks[key]) appData.breaks[key] = [];
    const active = appData.breaks[key].find(b => !b.end);
    if (active) active.end = new Date().toISOString();
    else appData.breaks[key].push({ start: new Date().toISOString(), end: null });
    document.getElementById('btnBreak').innerText = active ? "Start Break" : "End Break";
    saveData();
}

function saveTodo() {
    const val = document.getElementById('modalInput').value;
    if(val) { appData.todos.push({text:val, done:false}); saveData(); renderTodos(); closeTodoModal(); }
}
function deleteTodo(i) { appData.todos.splice(i, 1); saveData(); renderTodos(); }
function toggleTodo(i) { appData.todos[i].done = !appData.todos[i].done; saveData(); renderTodos(); }
function openTodoModal() { document.getElementById('todoModal').style.display='flex'; }
function closeTodoModal() { document.getElementById('todoModal').style.display='none'; }
function saveMemo() { appData.memo = document.getElementById('memoInput').value; saveData(); }

function updateCumulative() {
    let days = 0, totalMs = 0;
    Object.keys(appData.punches).forEach(k => {
        days++;
        let lastIn = null;
        appData.punches[k].forEach(p => {
            if(p.type==='in') lastIn = new Date(p.time);
            else if(lastIn) { totalMs += (new Date(p.time) - lastIn); lastIn = null; }
        });
    });
    document.getElementById('totalDays').innerText = days;
    document.getElementById('totalHours').innerText = formatDur(totalMs);
}

function renderCalendar() {
    const grid = document.getElementById('calGrid');
    const now = new Date();
    const days = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    grid.innerHTML = '';
    for(let d=1; d<=days; d++) {
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.innerText = d;
        const k = new Date(now.getFullYear(), now.getMonth(), d).toLocaleDateString('en-CA', {timeZone:'America/New_York'});
        if(appData.punches[k]) cell.classList.add('has-punch');
        grid.appendChild(cell);
    }
}

function formatDur(ms) {
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    return `${h}h ${m}m`;
}

function initTenure() {
    const diff = Math.floor((new Date() - new Date(START_DATE)) / 86400000);
    document.getElementById('tenureCounter').innerText = `Day ${diff}`;
}

function fullReset() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
